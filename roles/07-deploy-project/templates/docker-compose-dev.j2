version: "3"
services:
  php:
    build:
      context: ./project
      dockerfile: docker/php/Dockerfile
    restart: always
    volumes:
      - ./project:/var/www/app
    environment:
      - PHP_IDE_CONFIG=serverName=Docker
    extra_hosts:
      - "mysql:94.130.217.190"
      - "redis:94.130.217.190"
      - "rabbitmq:94.130.217.190"    

  nginx:
    build:
      context: ./project
      dockerfile: docker/nginx/Dockerfile
    restart: always
    volumes:
      - ./project:/var/www/app
    ports:
      - "8080:80"
    extra_hosts:
      - "mysql:94.130.217.190"
      - "redis:94.130.217.190"
      - "rabbitmq:94.130.217.190"

  workers:
    build:
      context: ./project
      dockerfile: docker/php/Dockerfile
    entrypoint: [ "supervisord", "-c", "/etc/supervisor/supervisord.conf", "-n", "-uroot", "-s" ]
    restart: always
    deploy:
      replicas: 16
      resources:
        limits:
          cpus: "1"
          memory: 3G
        reservations:
          cpus: "0.1"
          memory: 256M
    volumes:
      - ./project:/var/www/app
    environment:
      - PHP_IDE_CONFIG=serverName=Docker
      - BASE_APP_USER=root
    extra_hosts:
      - "mysql:94.130.217.190"
      - "redis:94.130.217.190"
      - "rabbitmq:94.130.217.190"

  cron:
    build:
      context: ./project
      dockerfile: docker/php/Dockerfile
    entrypoint: [ "cron", "-f" ]
    restart: always
    volumes:
      - ./project:/var/www/app
    extra_hosts:
      - "mysql:94.130.217.190"
      - "redis:94.130.217.190"
      - "rabbitmq:94.130.217.190"

  clickhouse:
    image: clickhouse/clickhouse-server
    volumes: 
      - ./clickhouse:/var/lib/clickhouse/
      - ./init-click-db.sh:/docker-entrypoint-initdb.d/init-db.sh
  redis:
    image: redis:alpine
    restart: always

  rabbitmq:
    image: rabbitmq:management-alpine
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER={{ RABBITMQ_DEFAULT_USER }}
      - RABBITMQ_DEFAULT_PASS={{ RABBITMQ_DEFAULT_PASS }}

  mysql:
    image: mysql:8
    restart: always
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8G
        reservations:
          cpus: "2"
          memory: 1G
    environment:
      - MYSQL_ROOT_PASSWORD="{{ MYSQL_ROOT_PASSWORD }}"
    volumes:
      - ./mysql/data:/var/lib/mysql:rw
      - ./mysql/config:/etc/mysql:ro
